<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.geo.dsp.module.project.mapper.OperationLogMapper">
    <resultMap id="OperationLogResultMap" type="com.geo.dsp.module.data.entity.OperationLog">
        <id column="id" property="id"/>
        <result column="uuid" property="uuid"/>
        <result column="project_id" property="projectId"/>
        <result column="engineering_id" property="engineeringId"/>
        <result column="task_id" property="taskId"/>
        <result column="log_date" property="logDate"/>
        <result column="content" property="content"/>
        <result column="creator_id" property="creatorId"/>
        <result column="create_time" property="createTime"/>
        <result column="update_by" property="updateBy"/>
        <result column="update_time" property="updateTime"/>
        <result column="is_del" property="isDel"/>
    </resultMap>

    <select id="selectByUuid" resultMap="OperationLogResultMap">
        SELECT * FROM operation_log WHERE uuid = #{uuid} AND is_del = false
    </select>

    <select id="listByProjectUuid" resultMap="OperationLogResultMap">
        SELECT ol.* FROM operation_log ol
                             LEFT JOIN project p ON ol.project_id = p.id
        WHERE p.uuid = #{projectUuid} AND ol.is_del = false
        ORDER BY ol.create_time DESC
    </select>

    <select id="listByTaskUuid" resultMap="OperationLogResultMap">
        SELECT ol.* FROM operation_log ol
                             LEFT JOIN collect_task ct ON ol.task_id = ct.id
        WHERE ct.uuid = #{taskUuid} AND ol.is_del = false
        ORDER BY ol.create_time DESC
    </select>

    <select id="listByLogDate" resultMap="OperationLogResultMap">
        SELECT * FROM operation_log
        WHERE log_date = #{logDate} AND creator_id = #{creatorId} AND is_del = false
        ORDER BY create_time DESC
    </select>

    <insert id="insert" parameterType="com.geo.dsp.module.project.entity.OperationLog">
        INSERT INTO operation_log (
            uuid, project_id, engineering_id, task_id, log_date, content,
            creator_id, create_time, update_by, update_time, is_del
        ) VALUES (
                     #{uuid}, #{projectId}, #{engineeringId}, #{taskId}, #{logDate}, #{content},
                     #{creatorId}, #{createTime}, #{updateBy}, #{updateTime}, #{isDel}
                 )
    </insert>

    <update id="updateContentByUuid">
        UPDATE operation_log
        SET content = #{content}, update_by = #{updateBy}, update_time = NOW()
        WHERE uuid = #{uuid} AND is_del = false
    </update>

    <update id="deleteByUuid">
        UPDATE operation_log SET is_del = true, update_by = #{updateBy}, update_time = NOW()
        WHERE uuid = #{uuid}
    </update>
</mapper>